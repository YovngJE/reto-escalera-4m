<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estrategia Reto Escalera: 20k a 4M</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 350px;
            margin: 0 auto;
        }
        /* Custom styling for sliders */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #059669; /* emerald-600 */
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }

        /* Confetti Pulse Animation */
        @keyframes pulse-confetti {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); box-shadow: 0 0 20px rgba(5, 150, 105, 0.8); }
        }
        .confetti-pulse {
            animation: pulse-confetti 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìà</span>
                    <span class="font-bold text-xl tracking-tight text-emerald-900">Reto Escalera 4M</span>
                </div>
                <div class="text-sm font-medium text-stone-500 hidden sm:block">
                    Del 26 Nov al 20 Dic 2025
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- Hero / Context -->
        <section class="text-center max-w-3xl mx-auto space-y-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-stone-900">
                De <span class="text-emerald-600">$20,000</span> a <span class="text-emerald-600">$4,000,000</span>
            </h1>
            <p class="text-lg text-stone-600 leading-relaxed">
                Este panel interactivo visualiza tu plan de <strong>Inter√©s Compuesto</strong>. 
                Necesitas acertar <strong>13 apuestas consecutivas</strong> con cuota promedio de <span id="currentOddsDisplay" class="font-bold text-blue-600">1.50</span>. 
                Usa el simulador abajo para ver tu progreso proyectado d√≠a a d√≠a.
            </p>
            <div class="flex justify-center gap-4 text-sm font-semibold">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">D√≠as: 24</span>
                
                <!-- Win Streak Badge (Visible when streak < 13) -->
                <span id="winStreakBadge" class="bg-red-100 text-red-800 px-3 py-1 rounded-full transition-colors">Racha Actual: 0</span>

                <!-- Celebration Message (Visible when streak >= 13) -->
                <div id="winGoalCelebration" class="hidden bg-emerald-600 text-white px-4 py-1 rounded-full shadow-lg confetti-pulse">
                    <span class="font-extrabold text-lg">üéâ ¬°META CUMPLIDA! 4M üéâ</span>
                </div>
            </div>
        </section>

        <!-- Interactive Simulator Dashboard -->
        <section class="bg-white rounded-2xl shadow-lg border border-stone-200 overflow-hidden">
            <div class="p-6 md:p-8 bg-stone-900 text-white">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
                    <span>üéõÔ∏è</span> Simulador de Proyecci√≥n
                </h2>
                <p class="text-stone-400 text-sm">Ajusta la cuota y el paso actual para ver c√≥mo cambia tu estrategia de retiro y el crecimiento.</p>
            </div>

            <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Controls Side -->
                <div class="lg:col-span-5 space-y-8">
                    
                    <!-- Odds Control -->
                    <div class="space-y-4 pt-2">
                        <div class="flex justify-between items-end">
                            <label class="font-bold text-stone-700">Cuota Base: <span id="oddsValueDisplay" class="text-blue-600 text-2xl">1.50</span></label>
                            <span class="text-stone-500 font-mono text-sm">1.10 a 2.00</span>
                        </div>
                        <input type="range" id="oddsSlider" min="1.10" max="2.00" value="1.50" step="0.05" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Step Slider Control -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <label class="font-bold text-stone-700">Paso Actual: <span id="stepDisplay" class="text-emerald-600 text-2xl">1</span>/14</label>
                            <span id="dateDisplay" class="text-stone-500 font-mono text-sm">26-Nov</span>
                        </div>
                        <input type="range" id="stepSlider" min="1" max="14" value="1" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-stone-400">
                            <span>Inicio</span>
                            <span>Mitad</span>
                            <span>Meta</span>
                        </div>
                    </div>

                    <!-- Plan B Toggle -->
                    <div class="bg-orange-50 border border-orange-100 p-4 rounded-xl flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-stone-800">üõ°Ô∏è Activar Plan B (Seguro)</h3>
                            <p class="text-xs text-stone-600 mt-1">Retirar ganancia en el Paso 10 y continuar solo con $1M.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="planBToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-stone-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                        </label>
                    </div>

                    <!-- Dynamic Stats -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p class="text-xs text-emerald-700 uppercase font-bold tracking-wider">Apuesta del D√≠a</p>
                            <p id="betAmountDisplay" class="text-xl md:text-2xl font-bold text-stone-900 mt-1">$20,000</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-xs text-blue-700 uppercase font-bold tracking-wider">Ganancia Neta</p>
                            <p id="profitDisplay" class="text-xl md:text-2xl font-bold text-stone-900 mt-1">$10,000</p>
                        </div>
                        <div class="col-span-2 bg-stone-100 p-4 rounded-xl border border-stone-200">
                            <p class="text-xs text-stone-500 uppercase font-bold tracking-wider">Saldo Final Proyectado (Este paso)</p>
                            <p id="totalBalanceDisplay" class="text-3xl md:text-4xl font-extrabold text-emerald-600 mt-2">$30,000</p>
                        </div>
                    </div>

                </div>

                <!-- Chart Side -->
                <div class="lg:col-span-7 flex flex-col justify-center">
                    <div class="mb-4">
                        <h3 class="font-bold text-lg text-stone-800 mb-1">Curva de Crecimiento Exponencial</h3>
                        <p class="text-sm text-stone-500">Observa c√≥mo el inter√©s compuesto acelera las ganancias despu√©s del paso 8.</p>
                    </div>
                    <div class="chart-container bg-white rounded-xl border border-stone-100 p-2">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Strategy Section -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="col-span-1 md:col-span-3">
                <h2 class="text-2xl font-bold text-stone-900 mb-2">T√°cticas para Cuota <span id="tacticOddsDisplay">1.50</span></h2>
                <p class="text-stone-600">Para lograr 13 aciertos seguidos, la selecci√≥n del mercado es cr√≠tica. Busca estas oportunidades:</p>
            </div>

            <!-- Tactic 1 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-xl mb-4">‚öΩ</div>
                <h3 class="font-bold text-lg mb-2">M√°s de 1.5 Goles</h3>
                <p class="text-sm text-stone-600">Busca partidos de equipos ofensivos o defensas d√©biles. Necesitas solo 2 goles en el partido, sin importar qui√©n los marque.</p>
            </div>

            <!-- Tactic 2 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-xl mb-4">üõ°Ô∏è</div>
                <h3 class="font-bold text-lg mb-2">Doble Oportunidad</h3>
                <p class="text-sm text-stone-600">"Gana Local o Empata" (1X). √ösalo cuando un favorito juegue en casa. Reduce dr√°sticamente el riesgo de perder.</p>
            </div>

            <!-- Tactic 3 -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 hover:shadow-md transition-shadow">
                <div class="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center text-xl mb-4">ü§ù</div>
                <h3 class="font-bold text-lg mb-2">Apuesta Sin Empate</h3>
                <p class="text-sm text-stone-600">Si el partido termina en empate, te devuelven el dinero. No ganas, pero no pierdes la racha. Ideal para proteger el capital en pasos avanzados.</p>
            </div>
        </section>

        <!-- Data Table Section -->
        <section>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-stone-900">Hoja de Ruta Detallada</h2>
                <button onclick="copyTable()" class="text-sm bg-stone-200 hover:bg-stone-300 text-stone-800 px-4 py-2 rounded-lg transition-colors font-medium">
                    üìã Copiar Datos
                </button>
            </div>
            <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-stone-200">
                <table class="min-w-full divide-y divide-stone-200 text-sm">
                    <thead class="bg-stone-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Paso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Saldo Inicial</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Apuesta</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-stone-500 uppercase tracking-wider">Cuota</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Ganancia</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Saldo Final</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-stone-500 uppercase tracking-wider">Cumplido</th> <!-- New Header -->
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-stone-200">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <footer class="text-center text-stone-400 text-sm py-8 border-t border-stone-200 mt-8">
            <p>Recuerda apostar con responsabilidad. Esta herramienta es solo para fines informativos y de simulaci√≥n.</p>
        </footer>

    </main>

    <script type="module">
        // --- Firebase Setup (Persistence) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db;
        let auth;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // --- Data Configuration ---
        // Original data array only needs to define the start point and structure
        const initialDataStructure = [
            { step: 1, date: '26-Nov', start: 20000 },
            { step: 2, date: '28-Nov', start: 0 },
            { step: 3, date: '30-Nov', start: 0 },
            { step: 4, date: '02-Dic', start: 0 },
            { step: 5, date: '04-Dic', start: 0 },
            { step: 6, date: '06-Dic', start: 0 },
            { step: 7, date: '08-Dic', start: 0 },
            { step: 8, date: '10-Dic', start: 0 },
            { step: 9, date: '12-Dic', start: 0 },
            { step: 10, date: '14-Dic', start: 0 },
            { step: 11, date: '16-Dic', start: 0 },
            { step: 12, date: '18-Dic', start: 0 },
            { step: 13, date: '19-Dic', start: 0 },
            { step: 14, date: '20-Dic', start: 0 }
        ];

        // State variables
        let currentData = [];
        let baseOdds = 1.50; // New dynamic odds state
        let isPlanB = false;
        let chartInstance = null;
        let completionStatus = {}; // { 1: true, 2: false, ... }
        let isAuthReady = false;

        // Exposed functions for inline events
        window.toggleStepCompletion = toggleStepCompletion;
        window.copyTable = copyTable;

        // --- Core Logic ---

        function formatCurrency(val) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(val);
        }
        
        /**
         * Recalcula toda la tabla de la escalera bas√°ndose en la cuota base y el Plan B.
         * @returns {Array} La nueva estructura de datos de la escalera.
         */
        function calculateNewData() {
            const newData = JSON.parse(JSON.stringify(initialDataStructure)); // Deep copy
            let currentBalance = newData[0].start;

            for (let i = 0; i < newData.length; i++) {
                const step = newData[i];
                
                // Si no es el primer paso, toma el saldo final del paso anterior como saldo inicial
                if (i > 0) {
                    currentBalance = newData[i - 1].end;
                    step.start = currentBalance;
                }

                // Aplicar Plan B en el Paso 10 (√≠ndice 9)
                if (isPlanB && step.step === 10) {
                    // Check if the previous step was completed to calculate the correct withdrawal base
                    const previousStepEnd = i > 0 ? newData[i - 1].end : step.start;
                    const endBeforeWithdrawal = previousStepEnd * baseOdds;
                    
                    const withdrawalAmount = endBeforeWithdrawal - 1000000;
                    step.withdrawal = withdrawalAmount > 0 ? withdrawalAmount : 0; // Save withdrawal amount
                    currentBalance = 1000000; // Reset balance for the next step (Step 11)
                    step.bet = previousStepEnd; // Bet amount is always the starting balance of the step
                    step.profit = step.bet * (baseOdds - 1);
                    step.end = currentBalance; // Balance after withdrawal
                    
                    // Force re-calculation for Step 10 display:
                    step.bet = previousStepEnd;
                    step.profit = step.bet * (baseOdds - 1);
                    step.end = step.bet + step.profit; // The end amount *before* withdrawal
                    
                    // The actual balance for the next step (index 10) will be 1M
                } else {
                    // Normal step calculation
                    const bet = currentBalance;
                    const profit = bet * (baseOdds - 1);
                    const end = currentBalance + profit;

                    step.bet = bet;
                    step.odds = baseOdds;
                    step.profit = profit;
                    step.end = end;
                }
            }
            
            // Recalculate balances starting from Step 11 if Plan B is active
            if (isPlanB) {
                // The balance for the start of step 11 (index 10) is fixed at 1,000,000
                let currentBalanceAfterPlanB = 1000000; 

                for (let i = 10; i < newData.length; i++) {
                    const step = newData[i];
                    step.start = currentBalanceAfterPlanB;
                    step.bet = currentBalanceAfterPlanB;
                    step.profit = currentBalanceAfterPlanB * (baseOdds - 1);
                    step.end = currentBalanceAfterPlanB + step.profit;
                    currentBalanceAfterPlanB = step.end;
                }
            }


            return newData;
        }

        /**
         * Calcula la racha actual de aciertos consecutivos.
         */
        function calculateWinStreak() {
            let streak = 0;
            // Iterate from the first step upwards
            for (let i = 1; i <= initialDataStructure.length; i++) {
                if (completionStatus[i]) {
                    streak++;
                } else {
                    // If a step is incomplete, the streak is broken here.
                    break;
                }
            }
            return streak;
        }

        // --- Persistence Logic ---
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebase config not available. Persistence disabled.");
                isAuthReady = true; // Mark as ready even if disabled
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : '';
                
                if (__initial_auth_token) { 
                    await signInWithCustomToken(auth, __initial_auth_token); 
                } else { 
                    await signInAnonymously(auth); 
                }
                
                userId = auth.currentUser?.uid;
                isAuthReady = true;
                
                loadCompletionStatus(); // Start listening to data
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                isAuthReady = true; // Still mark as ready to allow the rest of the app to function
            }
        }

        const getCompletionDocRef = () => doc(db, `artifacts/${appId}/users/${userId}/ladder_metadata`, 'completions');

        function loadCompletionStatus() {
            if (!db || !userId) return;

            onSnapshot(getCompletionDocRef(), (docSnap) => {
                if (docSnap.exists()) {
                    completionStatus = docSnap.data().status || {};
                } else {
                    completionStatus = {};
                }
                // Update UI when data is loaded/updated
                currentData = calculateNewData(); // Recalculate data when persistence status changes
                renderAll(); 
            }, (error) => {
                console.error("Error loading completion status:", error);
            });
        }

        async function saveCompletionStatus() {
            if (!db || !userId) {
                console.warn("Persistence not available. Cannot save status.");
                return;
            }

            try {
                await setDoc(getCompletionDocRef(), { status: completionStatus }, { merge: true });
            } catch (error) {
                console.error("Error saving completion status:", error);
            }
        }

        function toggleStepCompletion(stepId) {
            // Ensure stepId is number
            stepId = parseInt(stepId);
            
            // Allow checking/unchecking any step for flexibility, removing strict ladder constraint
            const isCompleted = !!completionStatus[stepId];
            completionStatus[stepId] = !isCompleted;
            saveCompletionStatus(); // Save and let onSnapshot trigger renderAll
        }


        // --- UI Updates ---
        function renderAll() {
            renderTable();
            // Re-run dashboard update to ensure highlight is correct
            const slider = document.getElementById('stepSlider');
            const index = parseInt(slider.value) - 1;
            updateDashboard(index); 
            // Chart update
            updateChartData();
            // Update win streak badge
            updateWinStreakBadge();
            // Update odds displays
            document.getElementById('currentOddsDisplay').textContent = baseOdds.toFixed(2);
            document.getElementById('tacticOddsDisplay').textContent = baseOdds.toFixed(2);
        }

        function updateWinStreakBadge() {
            const streak = calculateWinStreak();
            const badge = document.getElementById('winStreakBadge');
            const celebration = document.getElementById('winGoalCelebration');
            const totalSteps = initialDataStructure.length;
            
            if (streak >= totalSteps - 1) { // 13 steps is the goal (14 total, step 14 is final balance display)
                badge.classList.add('hidden');
                celebration.classList.remove('hidden');
            } else {
                badge.classList.remove('hidden');
                celebration.classList.add('hidden');

                badge.textContent = `Racha Actual: ${streak}`;
                
                if (streak > 0) {
                    badge.classList.remove('bg-red-100', 'text-red-800');
                    badge.classList.add('bg-emerald-100', 'text-emerald-800');
                } else {
                    badge.classList.remove('bg-emerald-100', 'text-emerald-800');
                    badge.classList.add('bg-red-100', 'text-red-800');
                }
            }
        }

        function updateDashboard(stepIndex) {
            const dataPoint = currentData[stepIndex];
            
            // Text Updates
            document.getElementById('stepDisplay').textContent = dataPoint.step;
            document.getElementById('dateDisplay').textContent = dataPoint.date;
            document.getElementById('betAmountDisplay').textContent = formatCurrency(dataPoint.bet);
            document.getElementById('profitDisplay').textContent = formatCurrency(dataPoint.profit);
            
            let finalBalance = dataPoint.end;
            let note = '';
            
            // Adjust display for Plan B withdrawal step (Step 10, index 9)
            if (isPlanB && dataPoint.step === 10) {
                // The 'end' property holds the balance before withdrawal for display purposes in this function
                note = ` (Antes de Retiro: ${formatCurrency(dataPoint.withdrawal)})`;
            }
            
            document.getElementById('totalBalanceDisplay').innerHTML = `${formatCurrency(finalBalance)}<span class="text-sm text-stone-500">${note}</span>`;


            // Table Highlight (Current Slider Position)
            const rows = document.querySelectorAll('#dataTableBody tr');
            rows.forEach((row, idx) => {
                // Check if this row matches the slider's current step AND is not already completed
                const isCurrent = idx === stepIndex;
                const isCompleted = completionStatus[idx + 1] === true;
                
                if(isCurrent && !isCompleted) {
                    row.classList.add('bg-stone-100', 'border-l-4', 'border-stone-500');
                    row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    row.classList.remove('bg-stone-100', 'border-l-4', 'border-stone-500');
                }
            });

            // Update Chart Highlight (Active point)
            if(chartInstance) {
                const colors = currentData.map((_, i) => {
                    const stepId = i + 1;
                    if (i === stepIndex) return '#ef4444'; // Red for current step
                    if (completionStatus[stepId]) return '#059669'; // Green for completed
                    return '#e5e7eb'; // Gray for pending
                });
                const pointRadii = currentData.map((_, i) => i === stepIndex ? 8 : (completionStatus[i + 1] ? 6 : 4));
                
                chartInstance.data.datasets[0].pointBackgroundColor = colors;
                chartInstance.data.datasets[0].pointRadius = pointRadii;
                chartInstance.update('none'); 
            }
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            currentData.forEach((row, index) => {
                const stepId = row.step;
                const isCompleted = completionStatus[stepId] === true;
                
                let withdrawalNote = '';
                let finalBalance = row.end;
                
                if (isPlanB && row.step === 10) {
                    // Display the balance BEFORE withdrawal as the "final balance" for the step, 
                    // and show the withdrawal amount in the note.
                    withdrawalNote = `<br><span class="text-xs text-orange-600 font-bold">‚ö†Ô∏è Retiro: ${formatCurrency(row.withdrawal)}</span>`;
                }

                
                const completionIcon = isCompleted 
                    ? `<span class="text-emerald-600 text-xl cursor-pointer hover:opacity-75" title="Marcar como Pendiente" onclick="window.toggleStepCompletion(${stepId})">‚úÖ</span>` 
                    : `<span class="text-stone-300 text-xl cursor-pointer hover:text-stone-500" title="Marcar como Cumplido" onclick="window.toggleStepCompletion(${stepId})">‚¨ú</span>`;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-stone-50 transition-colors";
                
                if (isCompleted) {
                    // Highlight completed rows
                    tr.classList.add('bg-emerald-50', 'bg-opacity-50', 'border-l-4', 'border-emerald-500');
                    tr.classList.remove('hover:bg-stone-50'); // Reduce hover conflict
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-stone-900 font-medium">${row.step}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-stone-500">${row.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-stone-600">${formatCurrency(row.start)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-stone-600">${formatCurrency(row.bet)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-stone-600 font-mono">${row.odds.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-emerald-600 font-medium">+${formatCurrency(row.profit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-stone-900 font-bold">${formatCurrency(finalBalance)}${withdrawalNote}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${completionIcon}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function initChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.map(d => `Paso ${d.step}`),
                    datasets: [{
                        label: 'Saldo Acumulado',
                        data: currentData.map(d => d.end),
                        borderColor: '#10b981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        tension: 0.3, 
                        fill: true,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1c1917',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    // Special handling for Step 10 if Plan B is active, 
                                    // to show the amount before withdrawal on the chart.
                                    const step = context.dataIndex + 1;
                                    let displayValue = context.raw;
                                    
                                    if (isPlanB && step === 10 && currentData[context.dataIndex].withdrawal > 0) {
                                        // Display the final amount *before* withdrawal on the tooltip
                                        displayValue = currentData[context.dataIndex].end; 
                                    }
                                    return 'Saldo: ' + formatCurrency(displayValue);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f3f4f6' },
                            ticks: {
                                callback: function(value) {
                                    return value >= 1000000 ? (value/1000000) + 'M' : (value/1000) + 'k';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateChartData() {
            if(!chartInstance) return;
            
            // Map data for the chart. 
            // If Plan B is active and it's step 10, the chart should reflect the balance *after* withdrawal
            const chartPoints = currentData.map(d => {
                // If Plan B is active, the chart should show the end balance of 1M for step 10 (index 9)
                if (isPlanB && d.step === 10) {
                    return 1000000;
                }
                return d.end;
            });
            
            chartInstance.data.datasets[0].data = chartPoints;
            
            // Update line and point colors based on Plan B status
            const color = isPlanB ? '#f97316' : '#10b981';
            
            chartInstance.data.datasets[0].borderColor = color; 
            chartInstance.data.datasets[0].backgroundColor = `rgba(${isPlanB ? '249, 115, 22' : '16, 185, 129'}, 0.1)`;
            chartInstance.data.datasets[0].pointBackgroundColor = color;
            
            chartInstance.update();
        }

        function copyTable() {
            let text = "Paso\tFecha\tSaldo Inicial\tApuesta\tCuota\tGanancia\tSaldo Final\tCumplido\n";
            currentData.forEach(row => {
                const isCompleted = completionStatus[row.step] === true;
                
                // Calculate actual final balance for copy (after withdrawal if Plan B)
                let finalBalanceForCopy = row.end;
                if (isPlanB && row.step === 10) {
                    finalBalanceForCopy = 1000000; // After withdrawal
                }
                
                text += `${row.step}\t${row.date}\t${row.start}\t${row.bet}\t${row.odds.toFixed(2)}\t${row.profit}\t${finalBalanceForCopy}\t${isCompleted ? 'SI' : 'NO'}\n`;
            });
            // Using a simple custom message instead of alert()
            console.log("Datos copiados al portapapeles. ¬°P√©galos en Excel!");
            navigator.clipboard.writeText(text).then(() => {
                // You can add a visible message element here instead of alert()
                console.log("Datos copiados!");
            });
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Firebase setup and data load
            initFirebase().then(() => {
                // Initial calculation before chart init
                currentData = calculateNewData();
                
                // Initial Chart Render (must happen after data is loaded/initialized)
                initChart();
                renderAll(); 
            });

            // Step Slider Interaction
            const stepSlider = document.getElementById('stepSlider');
            stepSlider.addEventListener('input', (e) => {
                const index = parseInt(e.target.value) - 1;
                updateDashboard(index);
            });

            // Odds Slider Interaction (NEW)
            const oddsSlider = document.getElementById('oddsSlider');
            const oddsValueDisplay = document.getElementById('oddsValueDisplay');
            oddsSlider.addEventListener('input', (e) => {
                // Update internal state and display format
                baseOdds = parseFloat(e.target.value);
                oddsValueDisplay.textContent = baseOdds.toFixed(2);
                
                // Recalculate all data based on new odds
                currentData = calculateNewData();
                renderAll(); 
            });


            // Plan B Toggle
            const toggle = document.getElementById('planBToggle');
            toggle.addEventListener('change', (e) => {
                isPlanB = e.target.checked;
                
                // Recalculate all data based on new plan B status
                currentData = calculateNewData();
                renderAll(); 
                
                // Update dashboard with currently selected slider value
                const slider = document.getElementById('stepSlider');
                const currentIndex = parseInt(slider.value) - 1;
                updateDashboard(currentIndex);
            });
        });

    </script>
</body>
</html>
